{% extends "layout/basic.html" %}

{% block content %}
<div class="row">
  <div class="medium-12 columns">
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _(practiceContent.name) }} {{ _('Practice') }}</h1>
        <div class="section__tools">
          <a href="{{ url('typing_main') }}" class="button rounded">
            <i class="icon icon-back"></i> {{ _('Back') }}
          </a>
        </div>
      </div>
      
      <div class="section__body">
        <!-- 级别选择 -->
        <div class="level-selector">
          <h3>{{ _('Select Level') }}</h3>
          <div class="row">
            {% for level in practiceContent.levels %}
            <div class="medium-2 columns">
              <button class="level-btn button rounded {{ loop.index0 == 0 ? 'primary' : '' }}" 
                      data-level="{{ loop.index0 }}" 
                      data-text="{{ level }}">
                {{ _('Level') }} {{ loop.index }}
              </button>
            </div>
            {% endfor %}
          </div>
        </div>
        
        <!-- 打字区域 -->
        <div class="typing-area" id="typing-area" style="display: none;">
          <div class="typing-stats-live">
            <div class="stat-live">
              <span class="label">{{ _('WPM') }}:</span>
              <span class="value" id="wpm-live">0</span>
            </div>
            <div class="stat-live">
              <span class="label">{{ _('Accuracy') }}:</span>
              <span class="value" id="accuracy-live">100%</span>
            </div>
            <div class="stat-live">
              <span class="label">{{ _('Time') }}:</span>
              <span class="value" id="time-live">0:00</span>
            </div>
          </div>
          
          <div class="text-display" id="text-display"></div>
          <textarea class="text-input" id="text-input" placeholder="{{ _('Click here and start typing...') }}"></textarea>
          
          <div class="keyboard-visual" id="keyboard-visual">
            <!-- 虚拟键盘将由 JavaScript 生成 -->
          </div>
          
          <div class="typing-controls">
            <button class="button rounded primary" id="restart-btn">
              <i class="icon icon-refresh"></i> {{ _('Restart') }}
            </button>
            <button class="button rounded" id="stop-btn">
              <i class="icon icon-stop"></i> {{ _('Stop') }}
            </button>
          </div>
        </div>
        
        <!-- 结果显示 -->
        <div class="result-display" id="result-display" style="display: none;">
          <h2>{{ _('Practice Complete!') }}</h2>
          <div class="result-stats">
            <div class="result-stat">
              <div class="result-value" id="result-wpm">0</div>
              <div class="result-label">{{ _('Words Per Minute') }}</div>
            </div>
            <div class="result-stat">
              <div class="result-value" id="result-accuracy">0%</div>
              <div class="result-label">{{ _('Accuracy') }}</div>
            </div>
            <div class="result-stat">
              <div class="result-value" id="result-score">0</div>
              <div class="result-label">{{ _('Score') }}</div>
            </div>
          </div>
          <div class="result-actions">
            <button class="button rounded primary" id="try-again-btn">
              <i class="icon icon-refresh"></i> {{ _('Try Again') }}
            </button>
            <button class="button rounded" id="next-level-btn">
              <i class="icon icon-arrow-right"></i> {{ _('Next Level') }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.level-selector {
  margin-bottom: 30px;
}

.level-btn {
  width: 100%;
  margin-bottom: 10px;
}

.typing-area {
  background: #f5f5f5;
  padding: 20px;
  border-radius: 8px;
}

.typing-stats-live {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin-bottom: 20px;
}

.stat-live {
  text-align: center;
}

.stat-live .label {
  font-size: 0.9em;
  color: #666;
}

.stat-live .value {
  font-size: 1.5em;
  font-weight: bold;
  color: #1779ba;
  margin-left: 5px;
}

.text-display {
  background: white;
  padding: 20px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 1.2em;
  line-height: 1.8;
  margin-bottom: 20px;
  min-height: 100px;
}

.text-display .char {
  position: relative;
  display: inline-block;
}

.text-display .char.correct {
  color: #3adb76;
}

.text-display .char.incorrect {
  color: #cc4b37;
  background: #ffeeee;
}

.text-display .char.current {
  background: #1779ba;
  color: white;
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0.3; }
}

.text-input {
  width: 100%;
  padding: 15px;
  font-family: 'Courier New', monospace;
  font-size: 1.1em;
  border: 2px solid #ddd;
  border-radius: 4px;
  resize: none;
}

.text-input:focus {
  outline: none;
  border-color: #1779ba;
}

.keyboard-visual {
  margin-top: 20px;
  background: white;
  padding: 15px;
  border-radius: 8px;
}

.keyboard-row {
  display: flex;
  justify-content: center;
  margin-bottom: 5px;
}

.key {
  width: 40px;
  height: 40px;
  margin: 2px;
  border: 1px solid #ddd;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: monospace;
  background: #f8f8f8;
  transition: all 0.1s;
}

.key.space {
  width: 200px;
}

.key.active {
  background: #1779ba;
  color: white;
  transform: scale(0.95);
}

.key.next {
  background: #ffeb3b;
}

.typing-controls {
  margin-top: 20px;
  text-align: center;
}

.result-display {
  text-align: center;
  padding: 40px;
}

.result-stats {
  display: flex;
  justify-content: center;
  gap: 50px;
  margin: 30px 0;
}

.result-stat {
  text-align: center;
}

.result-value {
  font-size: 3em;
  font-weight: bold;
  color: #1779ba;
}

.result-label {
  font-size: 1.1em;
  color: #666;
  margin-top: 10px;
}

.result-actions {
  margin-top: 30px;
}
</style>

<script>
// 打字游戏核心逻辑
class TypingGame {
  constructor() {
    this.currentLevel = 0;
    this.currentText = '';
    this.userInput = '';
    this.startTime = null;
    this.endTime = null;
    this.charCount = 0;
    this.errorCount = 0;
    this.timer = null;
    this.isRunning = false;
    
    this.initElements();
    this.initEventListeners();
    this.initKeyboard();
  }
  
  initElements() {
    this.levelBtns = document.querySelectorAll('.level-btn');
    this.typingArea = document.getElementById('typing-area');
    this.textDisplay = document.getElementById('text-display');
    this.textInput = document.getElementById('text-input');
    this.resultDisplay = document.getElementById('result-display');
    this.wpmLive = document.getElementById('wpm-live');
    this.accuracyLive = document.getElementById('accuracy-live');
    this.timeLive = document.getElementById('time-live');
    this.keyboardVisual = document.getElementById('keyboard-visual');
  }
  
  initEventListeners() {
    this.levelBtns.forEach((btn, index) => {
      btn.addEventListener('click', () => this.selectLevel(index));
    });
    
    this.textInput.addEventListener('input', (e) => this.handleInput(e));
    this.textInput.addEventListener('keydown', (e) => this.handleKeyDown(e));
    
    document.getElementById('restart-btn').addEventListener('click', () => this.restart());
    document.getElementById('stop-btn').addEventListener('click', () => this.stop());
    document.getElementById('try-again-btn').addEventListener('click', () => this.restart());
    document.getElementById('next-level-btn').addEventListener('click', () => this.nextLevel());
  }
  
  initKeyboard() {
    const rows = [
      '1234567890-=',
      'qwertyuiop[]',
      'asdfghjkl;\'',
      'zxcvbnm,./'
    ];
    
    this.keyboardVisual.innerHTML = '';
    rows.forEach(row => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'keyboard-row';
      
      row.split('').forEach(char => {
        const key = document.createElement('div');
        key.className = 'key';
        key.dataset.char = char;
        key.textContent = char;
        rowDiv.appendChild(key);
      });
      
      this.keyboardVisual.appendChild(rowDiv);
    });
    
    // Add space bar
    const spaceRow = document.createElement('div');
    spaceRow.className = 'keyboard-row';
    const spaceKey = document.createElement('div');
    spaceKey.className = 'key space';
    spaceKey.dataset.char = ' ';
    spaceKey.textContent = 'Space';
    spaceRow.appendChild(spaceKey);
    this.keyboardVisual.appendChild(spaceRow);
  }
  
  selectLevel(level) {
    this.currentLevel = level;
    this.currentText = this.levelBtns[level].dataset.text;
    
    // Update button states
    this.levelBtns.forEach((btn, i) => {
      btn.classList.toggle('primary', i === level);
    });
    
    // Show typing area
    this.typingArea.style.display = 'block';
    this.resultDisplay.style.display = 'none';
    
    this.start();
  }
  
  start() {
    this.userInput = '';
    this.startTime = Date.now();
    this.charCount = 0;
    this.errorCount = 0;
    this.isRunning = true;
    
    this.textInput.value = '';
    this.textInput.focus();
    this.renderText();
    this.updateStats();
    
    // Start timer
    this.timer = setInterval(() => this.updateStats(), 100);
  }
  
  handleInput(e) {
    if (!this.isRunning) return;
    
    this.userInput = e.target.value;
    this.charCount = this.userInput.length;
    
    // Count errors
    this.errorCount = 0;
    for (let i = 0; i < this.userInput.length; i++) {
      if (this.userInput[i] !== this.currentText[i]) {
        this.errorCount++;
      }
    }
    
    this.renderText();
    this.updateStats();
    this.updateKeyboard();
    
    // Check if completed
    if (this.userInput.length >= this.currentText.length) {
      this.complete();
    }
  }
  
  handleKeyDown(e) {
    // Highlight pressed key
    const key = document.querySelector(`.key[data-char="${e.key}"]`);
    if (key) {
      key.classList.add('active');
      setTimeout(() => key.classList.remove('active'), 100);
    }
  }
  
  renderText() {
    const html = this.currentText.split('').map((char, i) => {
      let className = 'char';
      if (i < this.userInput.length) {
        className += this.userInput[i] === char ? ' correct' : ' incorrect';
      } else if (i === this.userInput.length) {
        className += ' current';
      }
      return `<span class="${className}">${char}</span>`;
    }).join('');
    
    this.textDisplay.innerHTML = html;
  }
  
  updateKeyboard() {
    // Clear previous highlights
    document.querySelectorAll('.key.next').forEach(key => {
      key.classList.remove('next');
    });
    
    // Highlight next key
    if (this.userInput.length < this.currentText.length) {
      const nextChar = this.currentText[this.userInput.length];
      const nextKey = document.querySelector(`.key[data-char="${nextChar}"]`);
      if (nextKey) {
        nextKey.classList.add('next');
      }
    }
  }
  
  updateStats() {
    if (!this.isRunning) return;
    
    const elapsed = (Date.now() - this.startTime) / 1000;
    const minutes = elapsed / 60;
    const words = this.charCount / 5; // Standard: 5 chars = 1 word
    const wpm = minutes > 0 ? Math.round(words / minutes) : 0;
    const accuracy = this.charCount > 0 ? Math.round((1 - this.errorCount / this.charCount) * 100) : 100;
    
    this.wpmLive.textContent = wpm;
    this.accuracyLive.textContent = accuracy + '%';
    this.timeLive.textContent = this.formatTime(elapsed);
  }
  
  formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }
  
  complete() {
    this.isRunning = false;
    this.endTime = Date.now();
    clearInterval(this.timer);
    
    const duration = Math.floor((this.endTime - this.startTime) / 1000);
    const wpm = Math.round((this.charCount / 5) / (duration / 60));
    const accuracy = Math.round((1 - this.errorCount / this.charCount) * 100);
    const score = Math.floor(wpm * accuracy * 0.1);
    
    // Show results
    document.getElementById('result-wpm').textContent = wpm;
    document.getElementById('result-accuracy').textContent = accuracy + '%';
    document.getElementById('result-score').textContent = score;
    
    this.typingArea.style.display = 'none';
    this.resultDisplay.style.display = 'block';
    
    // Submit results
    this.submitResults(wpm, accuracy, duration);
  }
  
  async submitResults(wpm, accuracy, duration) {
    try {
      const response = await fetch(window.location.href, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          mode: '{{ mode }}',
          level: this.currentLevel,
          wpm: wpm,
          accuracy: accuracy / 100,
          duration: duration,
          charCount: this.charCount,
          errorCount: this.errorCount,
        }),
      });
      
      const data = await response.json();
      if (data.success) {
        console.log('Results saved:', data);
      }
    } catch (error) {
      console.error('Failed to submit results:', error);
    }
  }
  
  restart() {
    this.typingArea.style.display = 'block';
    this.resultDisplay.style.display = 'none';
    this.start();
  }
  
  stop() {
    this.isRunning = false;
    clearInterval(this.timer);
    this.typingArea.style.display = 'none';
    this.resultDisplay.style.display = 'none';
  }
  
  nextLevel() {
    const nextLevel = (this.currentLevel + 1) % this.levelBtns.length;
    this.selectLevel(nextLevel);
  }
}

// Initialize game when page loads
document.addEventListener('DOMContentLoaded', () => {
  new TypingGame();
});
</script>
{% endblock %}