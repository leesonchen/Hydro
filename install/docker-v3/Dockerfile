FROM ubuntu:22.04

# è®¾ç½®ç¯å¢ƒå˜é‡ - ä¿®å¤Nixå®‰è£…çš„å…³é”®é—®é¢˜
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=zh_CN.UTF-8
ENV LC_ALL=zh_CN.UTF-8
ENV TZ=Asia/Shanghai
ENV HOME=/root
ENV USER=root

# # é…ç½®å›½å†…é•œåƒæº
RUN cp /etc/apt/sources.list /etc/apt/sources.list.bak && \
    echo "deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list

# # å®‰è£…åŸºç¡€å·¥å…·
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    ca-certificates \
    locales \
    tzdata \
    sudo \
    systemd \
    init \
    procps \
    git \
    vim \
    net-tools \
    htop \
    tree \
    build-essential \
    jq \
    && rm -rf /var/lib/apt/lists/*

# # è®¾ç½®ä¸­æ–‡locale
RUN sed -i '/zh_CN.UTF-8/s/^# //g' /etc/locale.gen && \
    locale-gen

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p /data/db /data/file /tmp /root/.hydro \
    /data-host /root/.hydro-host /var/log/hydro /var/lib/mongodb


# å®‰è£… Nix (ä¸‹è½½ã€æ‰§è¡Œå®‰è£…è„šæœ¬ï¼Œç„¶åå®‰è£…NixåŒ…)
RUN echo "â¬‡ï¸ ä¸‹è½½å¹¶è¿è¡Œ Nix å®‰è£…è„šæœ¬..." && \
    curl -fsSL https://hydro.ac/nix.sh -o /tmp/nix.sh && \
    chmod +x /tmp/nix.sh && \
    /tmp/nix.sh --no-daemon && \
    echo "ğŸ”§ å®‰è£… Nix ç¯å¢ƒåŒ… (nodejs, coreutils, qrencode)..." && \
    # ç¡®ä¿åœ¨åŒä¸€å±‚ä¸­source Nixç¯å¢ƒï¼Œä»¥ä¾¿nix-envå‘½ä»¤å¯ç”¨
    . /root/.nix-profile/etc/profile.d/nix.sh && \
    nix-env -iA nixpkgs.nodejs nixpkgs.coreutils nixpkgs.qrencode

# è®¾ç½® PATH ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿ Nix å·¥å…·åœ¨åç»­ RUN å‘½ä»¤å’Œå®¹å™¨è¿è¡Œæ—¶å¯ç”¨
ENV PATH="/root/.nix-profile/bin:$PATH"

# ä¸‹è½½å¹¶è¿è¡Œ Hydro å®‰è£…è„šæœ¬æ¥å®‰è£… Hydro (è¿™ä¼šåˆ›å»º /root/.hydro å†…å®¹å¹¶å®‰è£… pm2)
RUN echo "â¬‡ï¸ ä¸‹è½½å¹¶è¿è¡Œ Hydro å®‰è£…è„šæœ¬..." && \
    curl -fsSL https://hydro.ac/setup.sh -o /tmp/hydro-setup.sh && \
    chmod +x /tmp/hydro-setup.sh && \
    echo "ğŸ”§ å¼€å§‹å®‰è£… Hydro..." && \
    LANG=zh bash /tmp/hydro-setup.sh

# ä¿å­˜ PM2 è¿›ç¨‹åˆ—è¡¨åˆ°é•œåƒä¸­ï¼Œä»¥ä¾¿åœ¨å®¹å™¨å¯åŠ¨æ—¶å¯ä»¥æ¢å¤
RUN if command -v pm2 >/dev/null 2>&1; then \
    echo "âœ… ä¿å­˜ PM2 è¿›ç¨‹åˆ—è¡¨åˆ°é•œåƒ..."; \
    pm2 save; \
    else \
    echo "âš ï¸ PM2 æœªæ‰¾åˆ°ï¼Œè·³è¿‡ä¿å­˜è¿›ç¨‹åˆ—è¡¨."; \
    fi

# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY start-hydro.sh /start.sh
RUN chmod +x /start.sh

# æš´éœ²ç«¯å£
EXPOSE 80 8888 27017

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /root

# å¯åŠ¨è„šæœ¬
CMD ["/start.sh"]