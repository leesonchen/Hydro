# Hydro 整体架构设计文档

## 1. 项目概述

Hydro 是一个高效的信息学在线测评系统，具有易安装、跨平台、多功能、可扩展的特点。系统采用模块化设计，支持插件系统，能够满足不同规模和需求的在线测评场景。

### 1.1 核心特性

- **模块化插件系统**：基于 Cordis 框架的插件架构，支持功能热插拔
- **多租户支持**：单系统多空间设计，支持不同班级/院校分开管理
- **分布式评测**：支持多节点评测，自动负载均衡
- **全题型支持**：传统题、Special Judge、交互题、客观题等
- **跨平台兼容**：支持主流 Linux 发行版和 arm64 架构

## 2. 架构总览

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     Hydro System                           │
├─────────────────────────────────────────────────────────────┤
│                    Web Interface                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Frontend   │  │   Backend    │  │   Plugins    │     │
│  │  (ui-default)│  │  (hydrooj)   │  │  (Modules)   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
├─────────────────────────────────────────────────────────────┤
│                 Core Framework                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Cordis     │  │   Serializer │  │   Validator  │     │
│  │  Framework   │  │    System    │  │    System    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
├─────────────────────────────────────────────────────────────┤
│                   Service Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Database   │  │   Storage    │  │   Judge      │     │
│  │   Service    │  │   Service    │  │   Service    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
├─────────────────────────────────────────────────────────────┤
│                Infrastructure Layer                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   MongoDB    │  │   File       │  │   Message    │     │
│  │   Database   │  │   Storage    │  │   Queue      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈

- **后端语言**：TypeScript/Node.js
- **前端框架**：React + Stylus
- **数据库**：MongoDB
- **消息队列**：MongoDB 集合
- **文件存储**：本地文件系统/分布式存储
- **评测环境**：Docker/Sandbox

## 3. 核心模块设计

### 3.1 框架层 (Framework)

#### 3.1.1 Cordis 框架
- **功能**：提供插件生命周期管理、依赖注入、事件系统
- **核心文件**：`framework/framework/`
- **关键特性**：
  - 插件热加载和卸载
  - 依赖注入机制
  - 事件总线
  - 配置管理

#### 3.1.2 序列化系统
- **功能**：数据序列化和反序列化
- **文件位置**：`framework/framework/serializer.ts`
- **支持格式**：JSON、YAML、自定义格式

#### 3.1.3 验证系统
- **功能**：数据验证和类型检查
- **文件位置**：`framework/framework/validator.ts`
- **特性**：
  - 数据类型验证
  - 表单验证
  - API 参数验证

### 3.2 核心系统 (HydroOJ)

#### 3.2.1 Handler 系统
- **功能**：处理 HTTP 请求和响应
- **文件位置**：`packages/hydrooj/src/handler/`
- **包含模块**：
  - `contest.ts` - 比赛管理
  - `problem.ts` - 题目管理
  - `user.ts` - 用户管理
  - `record.ts` - 提交记录
  - `homework.ts` - 作业系统
  - `training.ts` - 训练系统

#### 3.2.2 Model 系统
- **功能**：数据模型和业务逻辑
- **文件位置**：`packages/hydrooj/src/model/`
- **核心模型**：
  - `user.ts` - 用户模型
  - `problem.ts` - 题目模型
  - `contest.ts` - 比赛模型
  - `record.ts` - 记录模型
  - `domain.ts` - 域模型
  - `storage.ts` - 存储模型

#### 3.2.3 Service 系统
- **功能**：系统服务和基础设施
- **文件位置**：`packages/hydrooj/src/service/`
- **服务类型**：
  - `db.ts` - 数据库服务
  - `storage.ts` - 存储服务
  - `server.ts` - HTTP 服务器
  - `worker.ts` - 后台任务

### 3.3 评测系统 (HydroJudge)

#### 3.3.1 评测流程
- **文件位置**：`packages/hydrojudge/src/`
- **核心组件**：
  - `daemon.ts` - 评测守护进程
  - `judge/` - 评测器
  - `sandbox/` - 沙箱系统
  - `compile.ts` - 编译器

#### 3.3.2 评测类型
- **传统题**：`judge/default.ts`
- **交互题**：`judge/interactive.ts`
- **客观题**：`judge/objective.ts`
- **提交答案题**：`judge/submit_answer.ts`
- **通信题**：`judge/communication.ts`

### 3.4 用户界面 (UI-Default)

#### 3.4.1 前端架构
- **基础技术**：React + TypeScript
- **样式系统**：Stylus
- **组件库**：自定义组件系统
- **构建工具**：Webpack

#### 3.4.2 页面结构
- **文件位置**：`packages/ui-default/pages/`
- **主要页面**：
  - `problem_*.page.*` - 题目相关页面
  - `contest_*.page.*` - 比赛相关页面
  - `user_*.page.*` - 用户相关页面
  - `record_*.page.*` - 记录相关页面

## 4. 数据流设计

### 4.1 请求处理流程

```
Request → Router → Handler → Model → Database
   ↓         ↓        ↓       ↓        ↓
Response ← Serializer ← Business Logic ← Data
```

### 4.2 评测流程

```
Submit → Queue → Judge → Sandbox → Result
  ↓        ↓       ↓       ↓         ↓
Database ← Status ← Compile ← Execute ← Update
```

### 4.3 插件系统

```
Core System → Plugin Manager → Plugin Loader → Plugin Instance
     ↓             ↓              ↓               ↓
Event Bus ← Dependency Injection ← Lifecycle ← Implementation
```

## 5. 部署架构

### 5.1 单机部署

```
┌─────────────────────────────────────┐
│           Single Server             │
├─────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐      │
│  │   Hydro   │  │  MongoDB  │      │
│  │  Backend  │  │ Database  │      │
│  └───────────┘  └───────────┘      │
│  ┌───────────┐  ┌───────────┐      │
│  │   Judge   │  │   File    │      │
│  │  Service  │  │  Storage  │      │
│  └───────────┘  └───────────┘      │
└─────────────────────────────────────┘
```

### 5.2 分布式部署

```
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   Web Server    │  │   Web Server    │  │   Web Server    │
│   (Frontend)    │  │   (Frontend)    │  │   (Frontend)    │
└─────────────────┘  └─────────────────┘  └─────────────────┘
         │                     │                     │
         └─────────────────────┼─────────────────────┘
                               │
┌─────────────────────────────────────────────────────────────┐
│                    Load Balancer                           │
└─────────────────────────────────────────────────────────────┘
         │                     │                     │
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   App Server    │  │   App Server    │  │   App Server    │
│   (Backend)     │  │   (Backend)     │  │   (Backend)     │
└─────────────────┘  └─────────────────┘  └─────────────────┘
         │                     │                     │
         └─────────────────────┼─────────────────────┘
                               │
┌─────────────────────────────────────────────────────────────┐
│                   MongoDB Cluster                          │
└─────────────────────────────────────────────────────────────┘
         │                     │                     │
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   Judge Node    │  │   Judge Node    │  │   Judge Node    │
│   (Evaluator)   │  │   (Evaluator)   │  │   (Evaluator)   │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

## 6. 安全设计

### 6.1 权限系统

- **分层权限**：全局权限、域权限、角色权限
- **权限节点**：细粒度权限控制
- **用户组**：基于组的权限管理

### 6.2 安全措施

- **输入验证**：所有用户输入都经过验证
- **XSS 防护**：内容过滤和转义
- **CSRF 防护**：Token 验证
- **SQL 注入防护**：参数化查询
- **沙箱隔离**：评测环境完全隔离

## 7. 性能优化

### 7.1 数据库优化

- **索引策略**：关键字段建立索引
- **查询优化**：避免 N+1 查询
- **分页优化**：游标分页
- **缓存策略**：热点数据缓存

### 7.2 系统优化

- **连接池**：数据库连接复用
- **静态资源**：CDN 加速
- **压缩传输**：Gzip 压缩
- **异步处理**：非阻塞 I/O

## 8. 监控与日志

### 8.1 监控系统

- **系统监控**：CPU、内存、磁盘使用率
- **应用监控**：请求量、响应时间、错误率
- **业务监控**：用户活跃度、题目提交量

### 8.2 日志系统

- **访问日志**：记录所有 HTTP 请求
- **操作日志**：记录重要操作
- **错误日志**：记录系统错误
- **评测日志**：记录评测过程

## 9. 扩展性设计

### 9.1 插件系统

- **标准接口**：统一的插件接口
- **生命周期**：插件加载、卸载管理
- **依赖管理**：插件间依赖关系
- **热更新**：无需重启的插件更新

### 9.2 API 设计

- **RESTful API**：标准 REST 接口
- **GraphQL**：灵活的查询接口
- **WebSocket**：实时通信
- **版本控制**：API 版本管理

## 10. 总结

Hydro 系统采用了现代化的微服务架构设计，具有良好的可扩展性和可维护性。通过模块化的插件系统，系统能够灵活适应不同的业务需求。分布式的部署架构保证了系统的高可用性和可扩展性。完善的安全机制和性能优化策略确保了系统的稳定运行。